<!DOCTYPE html>
<html lang="en">

<head>
    <title>ZAPBOX‚ö°Ô∏èWEB INSTALLER</title>

    <!-- Primary Meta Tags -->
    <meta name="description" content="Flash & config your ZapBox from the browser">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />

    <!-- Open Graph -->
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="ZAPBOX‚ö°Ô∏èWEB INSTALLER" />
    <meta property="og:description"
        content="Flash & config your ZapBox from the browser" />
    <meta property="og:url" content="https://ereignishorizont.xyz/ZapBox/" />
    <meta property="og:image" content="https://ereignishorizont.xyz/ZapBox/assets/zapbox-social.webp" />

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://ereignishorizont.xyz/ZapBox">
    <meta name="twitter:title" content="ZAPBOX‚ö°Ô∏èWEB INSTALLER" />
    <meta name="twitter:description" content="Flash & config your ZapBox from the browser">
    <meta name="twitter:image" content="https://ereignishorizont.xyz/ZapBox/assets/zapbox-social.webp" />

    <link rel="icon" href="./assets/favicon.webp" sizes="32x32">
    <link rel="stylesheet" href="./assets/style.css">
    <script src="./assets/serial.js?v=2"></script>
    <script type="module" src="https://unpkg.com/esp-web-tools@9/dist/web/install-button.js?module"></script>
</head>

<body>
    <div class="wrapper">

        <noscript>
            <p>
                I'm sorry! For this to actully work you have to enable JavaScript in your browser.
            </p>
        </noscript>

        <h1 style="margin-bottom: 5px; display: inline-block;">ZAPBOX‚ö°Ô∏èWEB INSTALLER</h1>
        <p style="display: inline-block; margin: 0 0 0 10px; vertical-align: baseline;"><i>(Use with LILYGO T-Display-S3)</i></p>
        <div style="margin-bottom: 30px;"></div>

        <h2 id="flash">1- Flash firmware</h2>

        <ul>
            <li>Connect your ZapBox to the front USB port</li>
            <li>Keep latest or select your version from the drop-down menu</li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üî• Flash</span> - select the connection and follow screen instructions</li>
        </ul>

        <!-- ##### Version selector and flash button ##### -->

        <div class="buttons" style="display: flex; gap: 10px; align-items: center;">
            <select id="firmware-version" style="padding: 10px; font-size: 16px; border-radius: 4px;">
                <option value="./firmware/v929880/manifest.json">v929880 (Latest - Code Refactoring Release üîß)</option>
                <option value="./firmware/v929761/manifest.json">v929761 (Add bug fixes and external LED button support üîåüí°)</option>
                <option value="./firmware/v929303/manifest.json">v929303 (Add BTC-Ticker üöÄ and bug fixes)</option>
                <option value="./firmware/v929126/manifest.json">v929126 (Add Touch control and Multi-Channel-Control Mode)</option>
                <option value="./firmware/v928945/manifest.json">v928945 (Proactive error detection and optimized startup)</option>
                <option value="./firmware/v928559/manifest.json">v928559 (Small fixes and add BLACK & LIGHT GREY color theme)</option>
                <option value="./firmware/v927737/manifest.json">v927737 (Core dump support + fix config mode after deep sleep)</option>
                <option value="./firmware/v927726/manifest.json">v927726 (Add power saving modes with screensaver and deep sleep)</option>
                <option value="./firmware/v927292/manifest.json">v927292 (Add 4-step error handling and more cool stuff ü§ô)</option>
                <option value="./firmware/v926800/manifest.json">v926800 (Add options for color and special mode (blinking, etc.))</option>
                <option value="./firmware/v926705/manifest.json">v926705 (Add Threshold Mode with configurable payment trigger)</option>
                <option value="./firmware/v926666/manifest.json">v926666 (Add wss:// support for LNbits v1.3.1 and bS_extension v1.1.2)</option>
                <option value="./firmware/v926561/manifest.json">v926561 (Fix some bugs and edit documentation)</option>
                <option value="./firmware/v926531/manifest.json">v926531 (Initial Release - LNbits v0.12.12 / LNURLdevice v.0.6.9)</option>
            </select>
            
            <esp-web-install-button id="flash-button" manifest="./firmware/v929880/manifest.json">
                <button slot="activate">üî• Flash</button>
                <span slot="unsupported">Your browser does not support installing things on ESP devices. Use Google Chrome or Microsoft Edge.</span>
                <span slot="not-allowed">Ah snap, you are not allowed to use this on HTTP!</span>
            </esp-web-install-button>
        </div>

        <p><i><strong>Note:</strong> The configuration data can be deleted using "Erase device." Otherwise, it will be retained even with the new firmware. You can use LOGS & CONSOLE for debugging. To do this, press the RESET DEVICE button.</i></p>
        
        <script>
            // Update manifest when version is changed
            document.getElementById('firmware-version').addEventListener('change', function(e) {
                const flashButton = document.getElementById('flash-button');
                flashButton.setAttribute('manifest', e.target.value);
                console.log('Manifest changed to:', e.target.value);
            });
        </script>

        <hr>

        <h2 id="prepare-connection">2- Prepare connection</h2>

        <p>Flash the ESP32 with ‚ÄúErase device.‚Äù After the start screen is displayed, the ZapBox will automatically enter ‚ÄúCONF / SERIAL CONFIG MODE‚Äù.</p>

        <p>‚Üí The ZapBox is now ready to receive configuration data.</p>

        <p>If parameters have already been stored and need to be changed, you can also open CONF mode retrospectively:</p>
        <ul>
            <li>With the NEXT button: press and hold for 5 seconds.</li>
            <li>With the HELP touch button: Tap at least 5 times very quickly in succession.</li>
            <li>With the external LED button: Press once briefly and then hold for at least 5 seconds.</li>
        </ul>

        <p><i><strong>Note:</strong> If data is already available and you start the connection manually, the connection will remain active for 3 minutes (180 seconds) before it is automatically disconnected. You can terminate the connection prematurely by pressing the NEXT button, touching the display, or pressing the external button. </i></p>

        <hr>

        <h2 id="load-config">3- Load config values</h2>

        <ul>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üîå Connect</span> - select the connection and connect</li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üìñ Read Config</span> if values are available</li>
            <li>Define üìù your configuration</li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üî• Write Config</span></li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üîÑ Restart</span> to restart while staying connected</li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üîå Disconnect</span> or refresh website to close connection</li>
        </ul>

        <div class="buttons">
            <button id="connect-button" onclick="onConnectButtonClick()">üîå Connect</button>
            <button id="read-config-button" onclick="onReadConfigButtonClick()" disabled>üìñ Read Config</button>
            <button id="write-config-button" onclick="onWriteConfigButtonClick()" disabled>üî• Write Config</button>
            <button id="soft-reset-button" onclick="onSoftResetButtonClick()" disabled>üîÑ Restart</button>
            <button id="restart-button" onclick="onRestartButtonClick()" disabled>üîå Disconnect</button>
        </div>

        <div class="input-wrapper">
            <div>
                <label for="ssid">WiFi SSID</label>
                <input type="text" name="ssid" id="ssid" placeholder="SSID" autocomplete="off">
            </div>
            <div>
                <label for="wifiPassword">WiFi password</label>
                <input type="text" name="wifiPassword" id="wifiPassword" placeholder="password" autocomplete="off">
            </div>
            <div>
                <label for="socket">Device settings string</label>
                <input type="text" name="socket" id="socket" placeholder="ws://demo.lnbits.com/ap..." autocomplete="off">
            </div>
            <div>
                <label for="orientation">Screen orientation</label>
                <select name="orientation" id="orientation">
                    <option value="h" selected>Horizontal (default)</option>
                    <option value="v">Vertical</option>
                    <option value="hi">Horizontal (inverse)</option>
                    <option value="vi">Vertical (inverse)</option>
                </select>
            </div>
        </div>

        <div class="debug-console" id="consoleDebug"></div>
        
        <!-- Visual Separator
        <hr style="margin: 40px 0 30px 0; border: none; border-top: 1px solid #888;">
        -->

        <p style="text-align: center; font-size: 18px; margin-top: 20px;"><strong>Congratulations on configuring your own ZapBox! üéâ</strong></p>

        <p><i><strong>Note:</strong> You can see the logs from the device in the black terminal window when you are connected. Below you will find additional optional functions and settings.</i></p>

        <!-- Optional settings and functions Section -->
        <div style="margin-top: 50px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: -10px;">
                <h3 style="margin: 0; color: #000; font-weight: bold; white-space: nowrap;">Optional settings and functions</h3>
                <hr style="flex: 1; border: none; border-top: 1px solid #888; margin: 0;">
            </div>
            
            <div class="input-wrapper">
                <div>
                    <label for="theme">Display color options</label>
                    <select name="theme" id="theme">
                        <option value="zapbox" selected>ZAPBOX (default, Yellow & Black)</option>
                        <option value="black-white">BLACK & WHITE</option>
                        <option value="white-black">WHITE & BLACK</option>
                        <option value="yellow-black">YELLOW & BLACK</option>
                        <option value="black-red">BLACK & RED</option>
                        <option value="black-olive">BLACK & OLIVE</option>
                        <option value="white-navy">WHITE & NAVY</option>
                        <option value="white-darkcyan">WHITE & DARKCYAN</option>
                        <option value="darkgreen-green">DARKGREEN & GREEN</option>
                        <option value="darkgreen-lightgrey">DARKGREEN & LIGHTGREY</option>
                        <option value="red-green">RED & GREEN</option>
                        <option value="grey-blue">GREY & BLUE</option>
                        <option value="orange-brown">ORANGE & BROWN</option>
                        <option value="black-orange">BLACK & ORANGE</option>
                        <option value="brown-orange">BROWN & ORANGE</option>
                        <option value="black-btcorange">BLACK & BTC ORANGE</option>
                        <option value="maroon-magenta">MAROON & MAGENTA</option>
                        <option value="darkcyan-cyan">DARKCYAN & CYAN</option>
                        <option value="darkgrey-lightgrey">DARK GREY & LIGHT GREY</option>
                        <option value="black-lightgrey">BLACK & LIGHT GREY</option>
                    </select>
                </div>
                <div>
                    <label for="qrFormat">QR-Code Format</label>
                    <select name="qrFormat" id="qrFormat">
                        <option value="bech32" selected>LNURL in bech32 format (default)</option>
                        <option value="lud17">LNURL in LUD17 format (raw)</option>
                    </select>
                </div>
            </div>
            
            <p style="margin-top: 20px; color: #888;"><i><strong>Note:</strong> QR code format is used to generate the QR code. Recommended bech32.</i></p>
        </div>
        
        <!-- Section Separator -->
        <hr style="margin: 40px 0 30px 0; border: none; border-top: 1px solid #888;">
        
        <!-- Special Mode Section -->
        <div style="margin-top: 30px;">
            <div class="input-wrapper">
                <div>
                    <label for="specialMode">Special Mode</label>
                    <select name="specialMode" id="specialMode">
                        <option value="standard" selected>Standard (simple on/off - default)</option>
                        <option value="blink">Blink (1 Hz, 1:1)</option>
                        <option value="pulse">Pulse (2 Hz, 1:4)</option>
                        <option value="fast-blink">Strobe (5 Hz, 1:1)</option>
                        <option value="custom">Custom (manual settings)</option>
                    </select>
                    <p style="margin: -13px 0 0 0; font-size: 11px; color: #888; font-style: italic;">Choose pulsing/blinking mode for relay control</p>
                </div>
                <div id="frequencyDiv" style="display: none;">
                    <label for="frequency">Frequency (Hz)</label>
                    <input type="number" name="frequency" id="frequency" placeholder="0.1 to 10" step="0.1" min="0.1" max="10" autocomplete="off">
                    <p style="margin: -13px 0 0 0; font-size: 11px; color: #888; font-style: italic;">Cycles per second (0.1 - 10 Hz)</p>
                </div>
                <div id="dutyCycleDiv" style="display: none;">
                    <label for="dutyCycleRatio">Duty Cycle Ratio</label>
                    <input type="number" name="dutyCycleRatio" id="dutyCycleRatio" placeholder="0.1 to 10" step="0.1" min="0.1" max="10" autocomplete="off">
                    <p style="margin: -13px 0 0 0; font-size: 11px; color: #888; font-style: italic;">ON:OFF ratio (0.25 = 1:4, 1.0 = 1:1, 2.0 = 2:1)</p>
                </div>
            </div>
            
            <p style="margin-top: 20px; color: #888;"><i><strong>Note:</strong> Special modes control how the relay switches during the configured duration. "Standard" means simple on/off. Other modes create pulsing/blinking patterns with configurable frequency and duty cycle.</i></p>
            
            <!-- Section Separator -->
            <hr style="margin: 30px 0 20px 0; border: none; border-top: 1px solid #888;">
            
            <div class="input-wrapper">
                <div>
                    <label for="multiControl">Multi-Channel-Control Mode</label>
                    <select name="multiControl" id="multiControl">
                        <option value="off" selected>Single (1 channel - default)</option>
                        <option value="duo">Duo (2 channels)</option>
                        <option value="quattro">Quattro (4 channels)</option>
                    </select>
                </div>
            </div>
            
            <p style="margin-top: 20px; color: #888;"><i><strong>Multi-Channel-Control:</strong> Activate up to 4 GPIO pins (12, 13, 10, 11) with unique QR codes. Product labels and LNURLs are automatically retrieved from your LNbits switch configuration. Use touch gestures (swipe ‚Üê‚Üí) or the button (if available) to navigate between products.</i></p>
            <p style="margin-top: 10px; color: #888;"><i><strong>Features:</strong> Automatic LNURL generation (Bech32/LUD17) ‚Ä¢ Backend product labels ‚Ä¢ Touch navigation ‚Ä¢ Currency symbol conversion (‚Ç¨‚ÜíEUR, $‚ÜíUSD, etc.)</i></p>
            <p style="margin-top: 10px; color: #888;"><i><strong>Note:</strong> Not compatible with the Threshold feature. Please disable it.</i></p>
        </div>

        <!-- Section Separator -->
        <hr style="margin: 40px 0 30px 0; border: none; border-top: 1px solid #888;">

        <!-- BTC-Ticker Section -->
        <div style="margin-top: 30px;">
            <div class="input-wrapper">
                <div>
                    <label for="btcTicker">BTC-Ticker Mode</label>
                    <select name="btcTicker" id="btcTicker">
                        <option value="off">OFF</option>
                        <option value="always">ON - always</option>
                        <option value="selecting" selected>ON - when selecting (default)</option>
                    </select>
                    <p style="margin: -13px 0 0 0; font-size: 11px; color: #888; font-style: italic;">Control when Bitcoin price/block info is shown</p>
                </div>
                <div>
                    <label for="currency">Currency (ISO Code)</label>
                    <input type="text" name="currency" id="currency" placeholder="USD" maxlength="3" autocomplete="off">
                    <p style="margin: -13px 0 0 0; font-size: 11px; color: #888; font-style: italic;">E.g. USD, EUR, GBP, JPY, CHF, TRY, CAD, BRL, CUP, etc.</p>
                </div>
            </div>
            
            <p style="margin-top: 20px; color: #888;"><i><strong>OFF:</strong> No ticker shown (Duo/Quattro: productSelectionScreen; Single: only QR code)</i></p>
            <p style="margin-top: 10px; color: #888;"><i><strong>ON - always:</strong> Ticker overlays screen, navigate with NEXT/swipe to show products temporarily (returns after timeout)</i></p>
            <p style="margin-top: 10px; color: #888;"><i><strong>ON - when selecting:</strong> Single: Ticker only visible for a short time after NEXT/swipe. Duo/Quattro: productSelectionScreen ‚Üí products ‚Üí ticker (at end of product cycle)</i></p>
        </div>

        <!-- Section Separator -->
        <hr style="margin: 40px 0 30px 0; border: none; border-top: 1px solid #888;">

        <!-- Threshold Mode Section -->
        <div style="margin-top: 30px;">
            <div class="input-wrapper">
                <div>
                    <label for="thresholdKey">Threshold Mode - Wallet Invoice/Read Key</label>
                    <input type="text" name="thresholdKey" id="thresholdKey" placeholder="e.g. c9e68ab036.." autocomplete="off">
                    <p style="margin: -13px 0 0 0; font-size: 11px; color: #888; font-style: italic;">leave empty for normal mode (default)</p>
                </div>
                <div>
                    <label for="thresholdAmount">Threshold value in satoshi</label>
                    <input type="number" name="thresholdAmount" id="thresholdAmount" placeholder="e.g. 21" autocomplete="off">
                    <p style="margin: -13px 0 0 0; font-size: 11px; color: transparent; font-style: italic; user-select: none;">placeholder</p>
                </div>
                <div>
                    <label for="thresholdPin">GPIO pin to be controlled</label>
                    <input type="number" name="thresholdPin" id="thresholdPin" placeholder="e.g. 12" value="12" autocomplete="off">
                    <p style="margin: -13px 0 0 0; font-size: 11px; color: #888; font-style: italic;">12 (default)</p>
                </div>
                <div>
                    <label for="thresholdTime">Control time for GPIO pin (ms)</label>
                    <input type="number" name="thresholdTime" id="thresholdTime" placeholder="e.g. 3000" autocomplete="off">
                </div>
                <div>
                    <label for="thresholdLnurl">LNURL or LIGHTNING ADDRESS for QR-Code</label>
                    <input type="text" name="thresholdLnurl" id="thresholdLnurl" placeholder="LNURL or lightning address" autocomplete="off">
                </div>
            </div>
            
            <p style="margin-top: 20px; color: #888;"><i><strong>Note:</strong> As soon as something is entered in the "Wallet Invoice/Read Key" field, "THRESHOLD MODE" becomes active. "NORMAL MODE" then no longer works. The data specified in the bitcoinSwitch extension, such as amount, PIN, and time, is ignored. Only a payment to the wallet with the invoice key counts.</i></p>
            
            <p style="margin-top: 10px; color: #888;"><i><strong>How can I use this?</strong> Either by receiving payment directly into the wallet or by using the "Pay Links" extension. There you can get a static LNURL and even a lightning address. Payments to these addresses then trigger the pin, provided the threshold value is reached or exceeded.</i></p>
        </div>

        <!-- Section Separator -->
        <hr style="margin: 40px 0 30px 0; border: none; border-top: 1px solid #888;">

        <!-- Screensaver and Deep Sleep Section -->
        <div style="margin-top: 30px;">
            <div class="input-wrapper">
                <div>
                    <label for="screensaver">Screensaver</label>
                    <select name="screensaver" id="screensaver">
                        <option value="off" selected>OFF (default)</option>
                        <option value="backlight">ON (backlight off)</option>
                    </select>
                </div>
                <div>
                    <label for="deepSleep">Deep sleep</label>
                    <select name="deepSleep" id="deepSleep">
                        <option value="off" selected>OFF (default)</option>
                        <option value="light">ON (light, power consumption: ~3-5mA)</option>
                        <option value="freeze">ON (freeze, power consumption: ~0.01-0.15mA)</option>
                    </select>
                </div>
                <div>
                    <label for="activationTime">Time until activation</label>
                    <input type="number" name="activationTime" id="activationTime" min="1" max="120" placeholder="5" autocomplete="off">
                    <p style="margin: -13px 0 0 0; font-size: 11px; color: #888; font-style: italic;">1-120 minutes</p>
                </div>
            </div>
            
            <p style="margin-top: 20px; color: #888;"><i><strong>Note:</strong> Screensaver and Deep Sleep cannot be active simultaneously. Press BOOT button or HELP button to deactivate and resume normal operation.</i></p>
            
            <p style="margin-top: 10px; color: #888;"><i><strong>Note:</strong> With the T-Display-S3 with touch, the screensaver mode can be used because the touch function remains active. Deep sleep disables touch wake-up for maximum power savings.</i></p>
            
            <p style="margin-top: 10px; color: #888;"><i><strong>Use Cases:</strong> Energy saving (screensaver ~80-90% and deep sleep up to ~99%), reducing device heat, extending display lifespan in always-on scenarios.</i></p>
        </div>

        <hr>

        <h2 id="troubleshoot">Troubleshoot</h2>

        <h3 id="mostimportant">Most important:</h3>

        <p>If something doesn't work properly, especially the serial communication "üìñ Read Config", then simply try again. If that does not help, refresh the website üîÑ with CTRL+F5 or CTRL+SHIFT+R and start over.</p>
        
        <h3 id="hardwareproblems">Hardware problems:</h3>

        <p>If non of the above works, reset board in boot mode and start over.</p>
            <ul>
                <li>Connect the board via the USB cable</li>
                <li>Press and hold the BOOT button</li>
                <li>While still pressing the BOOT button, press RESET</li>
                <li>Release the RESET button</li>
                <li>Release the BOOT button</li>
                <li><a href="#flash">Go to step 1</a></li>
            </ul>
        <img class="center-img" src="./assets/troubleshoot.jpg" />

        <h3 id="goaround">Go-around:</h3>

        <p>If you're experiencing strange problems with the ESP32 that could have various causes, try starting from scratch. Erase the complete flash memory and restore the ESP32 to its factory state. The easiest and safest way to do this is with ESP Tool.</p>
        
        <p><a href="https://espressif.github.io/esptool-js/" target="_blank" rel="noopener noreferrer">https://espressif.github.io/esptool-js/</a></p>
        
        <p>‚Üí Press: <strong>Connect</strong> > <strong>Erase Flash</strong></p>
        
        <p><i><strong>Note:</strong> Only one serial connection can be active at a time. Disconnect the active connection on the other side by refreshing the page. Please follow the same steps after clearing the memory using the ESP tool page so that you can use the ZapBox Web Installer again.</i></p>

        <h3 id="pinout">Pinout:</h3>
        
        <a href="./assets/Pinout.webp" target="_blank">
            <img class="center-img" src="./assets/Pinout.webp" />
        </a>
        
        <p style="text-align: center; margin-top: 10px;"><i>Source: <a href="https://lilygo.cc/products/t-display-s3?variant=42589373268149" target="_blank" rel="noopener noreferrer">lilygo.cc</a></i></p>

        <footer>
            <p>Built on the shoulders of giants by <a href="https://njump.to/npub1yynthqj2zv663t0v8jtmtnwm34ak2fwe6zys043weqlnxgyuw7qqnk23ds" target="_blank" rel="noopener noreferrer">@axelhamburch</a> | <a href="https://github.com/AxelHamburch/ZapBox" target="_blank" rel="noopener noreferrer">Github repo</a></p>
        </footer>
    </div>

    <script>
        const consoleDebug = document.getElementById('consoleDebug');
        const ssid = document.getElementById('ssid');
        const wifiPassword = document.getElementById('wifiPassword');
        const socket = document.getElementById('socket');
        const qrFormat = document.getElementById('qrFormat');
        const orientation = document.getElementById('orientation');
        const theme = document.getElementById('theme');
        const specialMode = document.getElementById('specialMode');
        const frequency = document.getElementById('frequency');
        const dutyCycleRatio = document.getElementById('dutyCycleRatio');
        const frequencyDiv = document.getElementById('frequencyDiv');
        const dutyCycleDiv = document.getElementById('dutyCycleDiv');
        const thresholdKey = document.getElementById('thresholdKey');
        const thresholdAmount = document.getElementById('thresholdAmount');
        const thresholdPin = document.getElementById('thresholdPin');
        const thresholdTime = document.getElementById('thresholdTime');
        const thresholdLnurl = document.getElementById('thresholdLnurl');
        const screensaver = document.getElementById('screensaver');
        const deepSleep = document.getElementById('deepSleep');
        const activationTime = document.getElementById('activationTime');
        const multiControl = document.getElementById('multiControl');
        const btcTicker = document.getElementById('btcTicker');
        const currency = document.getElementById('currency');
        
        // Show/hide custom frequency/duty cycle inputs based on special mode selection
        specialMode.addEventListener('change', function() {
            if (specialMode.value === 'custom') {
                frequencyDiv.style.display = 'block';
                dutyCycleDiv.style.display = 'block';
            } else {
                frequencyDiv.style.display = 'none';
                dutyCycleDiv.style.display = 'none';
            }
        });
        
        // Screensaver and Deep Sleep - mutually exclusive
        screensaver.addEventListener('change', function() {
            if (screensaver.value !== 'off' && deepSleep.value !== 'off') {
                deepSleep.value = 'off';
            }
        });
        
        deepSleep.addEventListener('change', function() {
            if (deepSleep.value !== 'off' && screensaver.value !== 'off') {
                screensaver.value = 'off';
            }
        });

        let config = [
            {
                "name": "ssid",
                "value": ""
            },
            {
                "name": "wifipassword",
                "value": ""
            },
            {
                "name": "socket",
                "value": ""
            },
            {
                "name": "qrFormat",
                "value": "bech32"
            },
            {
                "name": "orientation",
                "value": "h"
            },
            {
                "name": "theme",
                "value": "zapbox"
            },
            {
                "name": "thresholdKey",
                "value": ""
            },
            {
                "name": "thresholdAmount",
                "value": ""
            },
            {
                "name": "thresholdPin",
                "value": ""
            },
            {
                "name": "thresholdTime",
                "value": ""
            },
            {
                "name": "thresholdLnurl",
                "value": ""
            },
            {
                "name": "specialMode",
                "value": "standard"
            },
            {
                "name": "frequency",
                "value": "1.0"
            },
            {
                "name": "dutyCycleRatio",
                "value": "1.0"
            },
            {
                "name": "screensaver",
                "value": "off"
            },
            {
                "name": "deepSleep",
                "value": "off"
            },
            {
                "name": "activationTime",
                "value": "5"
            },
            {
                "name": "multiControl",
                "value": "off"
            },
            {
                "name": "btcTicker",
                "value": "selecting"
            },
            {
                "name": "currency",
                "value": "USD"
            }
        ]

        // Setup Web Serial using serial.js
        const serial = new Serial();
        serial.on(SerialEvents.CONNECTION_OPENED, onSerialConnectionOpened);
        serial.on(SerialEvents.CONNECTION_CLOSED, onSerialConnectionClosed);
        serial.on(SerialEvents.DATA_RECEIVED, onSerialDataReceived);
        serial.on(SerialEvents.ERROR_OCCURRED, onSerialErrorOccurred);

        function onSerialErrorOccurred(eventSender, error) {
            console.log("onSerialErrorOccurred", error);
        }

        let configModeCheckTimeout = null;
        let configModeVerified = false;
        let helloSendTimeout = null;
        let serialBuffer = ""; // Buffer for incoming serial data
        let justRestarted = false; // Flag to suppress normal mode detection after restart
        let lastDataReceivedTime = 0; // Track when we last received data
        let connectionMonitorInterval = null; // Connection health monitor
        let inactivityWarningShown = false; // Flag to show warning only once

        function onSerialConnectionOpened(eventSender) {
            console.log("onSerialConnectionOpened", eventSender);
            
            // Reset config mode flag
            configModeVerified = false;
            lastDataReceivedTime = Date.now(); // Initialize timestamp
            inactivityWarningShown = false; // Reset warning flag
            
            // Connection health monitor removed - caused too many false positives
            // User can see in the log whether device is responding or not
            connectionMonitorInterval = null;
            
            // Disable all buttons initially
            document.getElementById("connect-button").disabled = true;
            document.getElementById("read-config-button").disabled = true;
            document.getElementById("write-config-button").disabled = true;
            document.getElementById("soft-reset-button").disabled = true;
            document.getElementById("restart-button").disabled = true;
            
            const checkMsg = document.createElement('span');
            checkMsg.style.color = '#888';
            checkMsg.textContent = 'Checking for config mode...\n';
            consoleDebug.appendChild(checkMsg);
            consoleDebug.scrollTop = consoleDebug.scrollHeight;
            
            // Wait 500ms first to see if normal program output comes
            // If nothing comes, then send /hello
            helloSendTimeout = setTimeout(() => {
                if (configModeVerified === false) {
                    // No normal program output detected, send /hello
                    serial.writeLine("/hello");
                }
            }, 500);
            
            // Set timeout for config mode verification (3 seconds total)
            configModeCheckTimeout = setTimeout(() => {
                if (!configModeVerified) {
                    console.log("Config mode verification timeout - no ASCII art response");
                    const timeoutMsg = document.createElement('span');
                    timeoutMsg.style.color = '#ff4444';
                    timeoutMsg.textContent = '‚ö†Ô∏è Timeout - Device not in config mode\n';
                    consoleDebug.appendChild(timeoutMsg);
                    consoleDebug.scrollTop = consoleDebug.scrollHeight;
                    alert("‚ö†Ô∏è No serial config mode active\n\nPlease enter config mode by:\n- Holding BOOT button for 5 seconds, or\n- Flashing fresh firmware with empty config");
                    serial.close();
                }
            }, 3000);
        }

        function onSerialConnectionClosed(eventSender) {
            console.log("onSerialConnectionClosed", eventSender);
            
            // Clear connection monitor
            if (connectionMonitorInterval) {
                clearInterval(connectionMonitorInterval);
                connectionMonitorInterval = null;
            }
            
            // Clear timeouts if still running
            if (helloSendTimeout) {
                clearTimeout(helloSendTimeout);
                helloSendTimeout = null;
            }
            if (configModeCheckTimeout) {
                clearTimeout(configModeCheckTimeout);
                configModeCheckTimeout = null;
            }
            
            // Reset all connection state flags
            inactivityWarningShown = false;
            lastDataReceivedTime = 0;
            
            // Reset verification flag and buffer
            configModeVerified = false;
            serialBuffer = "";
            justRestarted = false; // Reset the restart flag on disconnect
            
            document.getElementById("connect-button").disabled = false;
            document.getElementById("read-config-button").disabled = true;
            document.getElementById("write-config-button").disabled = true;
            document.getElementById("soft-reset-button").disabled = true;
            document.getElementById("restart-button").disabled = true;
        }

        function onSerialDataReceived(eventSender, newData) {
            console.log("onSerialDataReceived", eventSender);
            console.log("Received data:", newData);
            
            // Update last data received timestamp
            lastDataReceivedTime = Date.now();
            
            // Reset inactivity warning flag when new data arrives
            inactivityWarningShown = false;
            
            // Append text without HTML parsing to preserve ASCII art formatting
            const textNode = document.createTextNode(newData + '\n');
            consoleDebug.appendChild(textNode);
            consoleDebug.scrollTop = consoleDebug.scrollHeight;

            // Check if we receive normal program output - this means NOT in config mode
            const hasNormalProgramOutput = newData.includes("[LOOP]") || 
                                          newData.includes("[WS]") ||
                                          newData.includes("Still waiting") ||
                                          newData.includes("[CHECK]");
            
            // Only show alert if NOT just restarted (allow viewing logs after restart)
            if (hasNormalProgramOutput && configModeVerified !== true && !justRestarted) {
                console.log("Normal program detected - NOT in config mode");
                
                // Cancel the /hello send timeout if still running
                if (helloSendTimeout) {
                    clearTimeout(helloSendTimeout);
                    helloSendTimeout = null;
                }
                
                // Clear the main timeout if still running
                if (configModeCheckTimeout) {
                    clearTimeout(configModeCheckTimeout);
                    configModeCheckTimeout = null;
                }
                
                const errorMsg = document.createElement('span');
                errorMsg.style.color = '#ff4444';
                errorMsg.textContent = '‚ö†Ô∏è Normal program running - not in config mode\n';
                consoleDebug.appendChild(errorMsg);
                consoleDebug.scrollTop = consoleDebug.scrollHeight;
                
                alert("‚ö†Ô∏è No serial config mode active\n\nPlease enter config mode by:\n- Holding BOOT button for 2-3 seconds, or\n- Flashing fresh firmware with empty config");
                serial.close();
                return; // Exit early
            }
            
            // Check for explicit config mode status markers from ESP32
            // Multiple fallbacks to ensure reliable detection:
            // 1. [CONFIG_MODE_ENTER] marker (primary)
            // 2. ASCII art from /hello response
            // 3. "Config mode triggered" log line
            // 4. "Config mode screen displayed" log line (always appears when CONF screen is shown)
            // 5. "--- Serial Config Mode Active ---" log line
            const hasConfigModeEnter = newData.includes("[CONFIG_MODE_ENTER]");
            
            const hasAsciiArt = !configModeVerified && (
                newData.includes("____") || 
                newData.includes("/_  /") || 
                newData.includes("/___/")
            );
            
            const hasConfigTriggerLog = !configModeVerified && (
                newData.includes("Config mode triggered") ||
                newData.includes("Config mode screen displayed") ||
                newData.includes("entering serial config") ||
                newData.includes("--- Serial Config Mode Active ---")
            );
            
            if ((hasConfigModeEnter || hasAsciiArt || hasConfigTriggerLog) && !configModeVerified) {
                console.log("Config mode ENTERED - ESP32 in config mode!");
                configModeVerified = true;
                justRestarted = false; // Clear restart flag since we're now in config mode
                
                // Clear the timeouts
                if (helloSendTimeout) {
                    clearTimeout(helloSendTimeout);
                    helloSendTimeout = null;
                }
                if (configModeCheckTimeout) {
                    clearTimeout(configModeCheckTimeout);
                    configModeCheckTimeout = null;
                }
                
                // Show success message
                setTimeout(() => {
                    const successMsg = document.createElement('span');
                    successMsg.style.color = '#00ff00';
                    successMsg.textContent = '\n‚úì Config mode active\n';
                    consoleDebug.appendChild(successMsg);
                    consoleDebug.scrollTop = consoleDebug.scrollHeight;
                }, 300);
                
                // Enable buttons after verification
                document.getElementById("connect-button").disabled = true;
                document.getElementById("read-config-button").disabled = false;
                document.getElementById("write-config-button").disabled = false;
                document.getElementById("soft-reset-button").disabled = false;
                document.getElementById("restart-button").disabled = false;
            }
            
            // Check for config mode exit
            if (newData.includes("[CONFIG_MODE_EXIT]")) {
                console.log("Config mode EXITED - disabling config buttons");
                configModeVerified = false;
                
                // Disable config buttons
                document.getElementById("read-config-button").disabled = true;
                document.getElementById("write-config-button").disabled = true;
            }

            // Accumulate serial data in buffer
            serialBuffer += newData;

            // Try to parse config data when we see /file-read
            if (serialBuffer.includes("/file-read ")) {
                tryParseConfig();
            }


            // Check for "no config file" message
            if (newData.includes("- Failed to open file for reading")) {
                alert("There is no config in the device, please fill options and write.");
            }
        }

        function tryParseConfig() {
            // Look for /file-read followed by JSON array
            let fileReadIndex = serialBuffer.lastIndexOf("/file-read ");
            if (fileReadIndex === -1) return;

            // Extract everything after /file-read
            let afterFileRead = serialBuffer.substring(fileReadIndex);
            
            // Find complete JSON array with matching brackets
            let jsonStart = afterFileRead.indexOf("[");
            if (jsonStart === -1) return;
            
            let bracketCount = 0;
            let inString = false;
            let escape = false;
            let jsonEnd = -1;
            
            for (let i = jsonStart; i < afterFileRead.length; i++) {
                let char = afterFileRead[i];
                
                if (escape) {
                    escape = false;
                    continue;
                }
                
                if (char === '\\') {
                    escape = true;
                    continue;
                }
                
                if (char === '"') {
                    inString = !inString;
                    continue;
                }
                
                if (!inString) {
                    if (char === '[') bracketCount++;
                    if (char === ']') {
                        bracketCount--;
                        if (bracketCount === 0) {
                            jsonEnd = i;
                            break;
                        }
                    }
                }
            }
            
            // Found complete JSON with matching brackets
            if (jsonEnd === -1) return;
            
            let jsonString = afterFileRead.substring(jsonStart, jsonEnd + 1);

            try {
                let configData = JSON.parse(jsonString);

                // Verify it's config data with expected structure
                if (!Array.isArray(configData) || configData.length < 5 || configData[0]?.name !== "ssid") {
                    return;
                }

                // Update config object
                config[0].value = configData[0].value; // ssid
                config[1].value = configData[1].value; // wifiPassword
                config[2].value = configData[2].value; // socket
                config[3].value = configData[3]?.value || "bech32"; // qrFormat
                config[4].value = configData[4].value; // orientation
                config[5].value = configData[5]?.value || "zapbox"; // theme
                config[6].value = configData[6]?.value || ""; // thresholdKey
                config[7].value = configData[7]?.value || ""; // thresholdAmount
                config[8].value = configData[8]?.value || ""; // thresholdPin
                config[9].value = configData[9]?.value || ""; // thresholdTime
                config[10].value = configData[10]?.value || ""; // thresholdLnurl
                config[11].value = configData[11]?.value || "standard"; // specialMode
                config[12].value = configData[12]?.value || "1.0"; // frequency
                config[13].value = configData[13]?.value || "1.0"; // dutyCycleRatio
                config[14].value = configData[14]?.value || "off"; // screensaver
                config[15].value = configData[15]?.value || "off"; // deepSleep
                config[16].value = configData[16]?.value || "5"; // activationTime
                config[17].value = configData[17]?.value || "off"; // multiControl
                config[18].value = configData[18]?.value || "always"; // btcTicker
                config[19].value = configData[19]?.value || "USD"; // currency

                // Fill form fields
                ssid.value = config[0].value;
                wifiPassword.value = config[1].value;
                socket.value = config[2].value;
                qrFormat.value = config[3].value;
                orientation.value = config[4].value;
                theme.value = config[5].value;
                thresholdKey.value = config[6].value;
                thresholdAmount.value = config[7].value;
                thresholdPin.value = config[8].value;
                thresholdTime.value = config[9].value;
                thresholdLnurl.value = config[10].value;
                specialMode.value = config[11].value;
                frequency.value = config[12].value;
                dutyCycleRatio.value = config[13].value;
                screensaver.value = config[14].value;
                deepSleep.value = config[15].value;
                activationTime.value = config[16].value;
                multiControl.value = config[17].value;
                btcTicker.value = config[18].value;
                currency.value = config[19].value;
                
                // Show/hide custom fields based on loaded special mode
                if (specialMode.value === 'custom') {
                    frequencyDiv.style.display = 'block';
                    dutyCycleDiv.style.display = 'block';
                } else {
                    frequencyDiv.style.display = 'none';
                    dutyCycleDiv.style.display = 'none';
                }

                console.log("Config loaded:", config);
                
                // Show success message
                const successMsg = document.createElement('span');
                successMsg.style.color = '#00ff00';
                successMsg.textContent = '\n‚úì Data loaded\n';
                consoleDebug.appendChild(successMsg);
                consoleDebug.scrollTop = consoleDebug.scrollHeight;
                
                // Clear buffer after successful parse
                serialBuffer = "";
            } catch (error) {
                // Silent - wait for more data
                console.log("JSON parse attempt failed:", error);
            }
        }

        async function onConnectButtonClick() {
            console.log("Connect button clicked!");

            if (navigator.serial) {
                if (!serial.isOpen()) {
                    await serial.connectAndOpen(portFilters = null, serialOptions = { baudRate: 115200 })
                } else {
                    console.log("The serial connection appears already open");
                }
            } else {
                alert('‚ö†Ô∏è The Web Serial API does not appear supported on this web browser.');
            }
        }

        async function onReadConfigButtonClick() {
            console.log("Read config button clicked!");
            serial.writeLine("/file-read config.json");
        }

        async function onWriteConfigButtonClick() {
            console.log("Write config button clicked!");
            
            // Check if we're in config mode
            if (!configModeVerified) {
                alert("‚ö†Ô∏è Config Mode Required\n\nTo write config data, the device must be in SERIAL CONFIG MODE.\n\nPlease:\n1. Disconnect current connection\n2. Put device in config mode (hold BOOT button 5 seconds)\n3. Reconnect and try again");
                
                const errorMsg = document.createElement('span');
                errorMsg.style.color = '#ff4444';
                errorMsg.textContent = '‚ö†Ô∏è Not in config mode - write aborted\n';
                consoleDebug.appendChild(errorMsg);
                consoleDebug.scrollTop = consoleDebug.scrollHeight;
                return;
            }
            
            // Update config array from form fields
            config[0].value = ssid.value;
            config[1].value = wifiPassword.value;
            config[2].value = socket.value;
            config[3].value = qrFormat.value;
            config[4].value = orientation.value;
            config[5].value = theme.value;
            config[6].value = thresholdKey.value;
            config[7].value = thresholdAmount.value;
            config[8].value = thresholdPin.value;
            config[9].value = thresholdTime.value;
            config[10].value = thresholdLnurl.value;
            config[11].value = specialMode.value;
            config[12].value = frequency.value || "1.0";
            config[13].value = dutyCycleRatio.value || "1.0";
            config[14].value = screensaver.value;
            config[15].value = deepSleep.value;
            config[16].value = activationTime.value || "5";
            config[17].value = multiControl.value;
            config[18].value = btcTicker.value;
            config[19].value = currency.value.toUpperCase() || "USD"; // Convert to uppercase
            
            // Validate required fields
            const ssidValue = config[0].value.trim();
            const wifiPasswordValue = config[1].value.trim();
            const socketValue = config[2].value.trim();
            const thresholdKeyValue = config[6].value.trim();
            const thresholdAmountValue = config[7].value.trim();
            const thresholdPinValue = config[8].value.trim();
            const thresholdTimeValue = config[9].value.trim();
            const thresholdLnurlValue = config[10].value.trim();
            const specialModeValue = config[11].value.trim();
            const frequencyValue = config[12].value.trim();
            const dutyCycleRatioValue = config[13].value.trim();
            
            // Check basic required fields
            if (!ssidValue || !wifiPasswordValue || !socketValue) {
                alert("‚ö†Ô∏è Validation Error\n\nThe following fields are required:\n- WiFi SSID\n- WiFi password\n- Device settings string");
                return;
            }
            
            // If Threshold Key is filled, check if all threshold fields are filled
            if (thresholdKeyValue && (!thresholdAmountValue || !thresholdPinValue || !thresholdTimeValue || !thresholdLnurlValue)) {
                alert("‚ö†Ô∏è Threshold Mode Validation Error\n\nIf 'Wallet Invoice/Read Key' is filled, all threshold fields are required:\n- Threshold value in satoshi\n- GPIO pin to be controlled\n- Control time for GPIO pin (ms)\n- LNURL or LIGHTNING ADDRESS for QR-Code");
                return;
            }
            
            // If Special Mode is custom, validate frequency and duty cycle
            if (specialModeValue === 'custom') {
                const freqNum = parseFloat(frequencyValue);
                const ratioNum = parseFloat(dutyCycleRatioValue);
                
                if (!frequencyValue || isNaN(freqNum) || freqNum < 0.1 || freqNum > 10) {
                    alert("‚ö†Ô∏è Special Mode Validation Error\n\nFor custom mode, frequency must be between 0.1 and 10 Hz");
                    return;
                }
                
                if (!dutyCycleRatioValue || isNaN(ratioNum) || ratioNum < 0.1 || ratioNum > 10) {
                    alert("‚ö†Ô∏è Special Mode Validation Error\n\nFor custom mode, duty cycle ratio must be between 0.1 and 10");
                    return;
                }
            }
            
            serial.writeLine("/file-remove config.json");
            serial.writeLine("/file-append config.json " + JSON.stringify(config));
            
            // Wait a moment for command to be processed
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Show success message
            const successMsg = document.createElement('span');
            successMsg.style.color = '#00ff00';
            successMsg.textContent = '‚úì Data written\n\n‚ö†Ô∏è To apply changes:\n- Press üîÑ Restart (if in Config Mode), or\n- Press üîå Disconnect and reset device manually\n';
            consoleDebug.appendChild(successMsg);
            consoleDebug.scrollTop = consoleDebug.scrollHeight;
        }

        async function onSoftResetButtonClick() {
            console.log("Restart button clicked!");
            
            const resetMsg = document.createElement('span');
            resetMsg.style.color = '#ffaa00';
            
            if (configModeVerified) {
                // In Config Mode: Use software reset (keeps serial connection alive)
                resetMsg.textContent = 'Sending software restart command...\n';
                consoleDebug.appendChild(resetMsg);
                consoleDebug.scrollTop = consoleDebug.scrollHeight;
                
                // Send soft reset command via serial
                serial.writeLine("/config-soft-reset");
                
                // Reset config mode verification flag
                configModeVerified = false;
                justRestarted = true;
                
                // Disable config-related buttons after restart
                document.getElementById("read-config-button").disabled = true;
                document.getElementById("write-config-button").disabled = true;
                
                // Wait for device to restart
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const doneMsg = document.createElement('span');
                doneMsg.style.color = '#00ff00';
                doneMsg.textContent = '‚úì Device restarted - Connection remains open for viewing logs\n\n‚ö†Ô∏è Device is now in normal mode.\nTo write new config, disconnect and enter config mode again (hold BOOT 5s)\n';
                consoleDebug.appendChild(doneMsg);
                consoleDebug.scrollTop = consoleDebug.scrollHeight;
                
            } else {
                // Not in Config Mode: Use hardware reset (DTR/RTS toggle)
                resetMsg.textContent = 'Performing hardware reset...\n';
                consoleDebug.appendChild(resetMsg);
                consoleDebug.scrollTop = consoleDebug.scrollHeight;
                
                try {
                    // Perform hardware reset
                    await serial.hardwareReset();
                    
                    // Wait for device to boot
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const doneMsg = document.createElement('span');
                    doneMsg.style.color = '#00ff00';
                    doneMsg.textContent = '‚úì Device restarted - Connection remains open for viewing boot logs\n';
                    consoleDebug.appendChild(doneMsg);
                    consoleDebug.scrollTop = consoleDebug.scrollHeight;
                } catch (error) {
                    const errorMsg = document.createElement('span');
                    errorMsg.style.color = '#ff0000';
                    errorMsg.textContent = '‚úó Hardware reset failed: ' + error.message + '\n';
                    consoleDebug.appendChild(errorMsg);
                    consoleDebug.scrollTop = consoleDebug.scrollHeight;
                }
            }
        }

        async function onRestartButtonClick() {
            console.log("Disconnect button clicked!");
            const restartMsg = document.createElement('span');
            restartMsg.style.color = '#ffaa00';
            restartMsg.textContent = 'Disconnecting...\n';
            consoleDebug.appendChild(restartMsg);
            consoleDebug.scrollTop = consoleDebug.scrollHeight;
            
            // Send restart command
            serial.writeLine("/config-restart");
            
            // Wait a moment for command to be sent
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Close serial connection before device restarts
            if (serial.isOpen()) {
                await serial.close();
                consoleDebug.innerHTML += '<b>Connection closed.</b><br>';
                consoleDebug.scrollTop = consoleDebug.scrollHeight;
            }
        }

        ssid.addEventListener("input", (event) => {
            config[0].value = event.target.value;
        });

        wifiPassword.addEventListener("input", (event) => {
            config[1].value = event.target.value;
        });

        socket.addEventListener("input", (event) => {
            config[2].value = event.target.value;
        });

        qrFormat.addEventListener("change", (event) => {
            config[3].value = event.target.value;
        });

        orientation.addEventListener("change", (event) => {
            config[4].value = event.target.value;
        });

        theme.addEventListener("change", (event) => {
            config[5].value = event.target.value;
        });

        thresholdKey.addEventListener("input", (event) => {
            config[6].value = event.target.value;
        });

        thresholdAmount.addEventListener("input", (event) => {
            config[7].value = event.target.value;
        });

        thresholdPin.addEventListener("input", (event) => {
            config[8].value = event.target.value;
        });

        thresholdTime.addEventListener("input", (event) => {
            config[9].value = event.target.value;
        });

        thresholdLnurl.addEventListener("input", (event) => {
            config[10].value = event.target.value;
        });

        screensaver.addEventListener("change", (event) => {
            config[14].value = event.target.value;
        });

        deepSleep.addEventListener("change", (event) => {
            config[15].value = event.target.value;
        });

        activationTime.addEventListener("input", (event) => {
            config[16].value = event.target.value;
        });

        btcTicker.addEventListener("change", (event) => {
            config[18].value = event.target.value;
        });

        currency.addEventListener("input", (event) => {
            config[19].value = event.target.value.toUpperCase();
            event.target.value = event.target.value.toUpperCase(); // Show uppercase in input
        });

    </script>

</body>
</html>