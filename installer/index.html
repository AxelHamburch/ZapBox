<!DOCTYPE html>
<html lang="en">

<head>
    <title>ZAPBOX‚ö°Ô∏èWEB INSTALLER</title>

    <!-- Primary Meta Tags -->
    <meta name="description" content="Flash & config your ZapBox from the browser">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />

    <!-- Open Graph -->
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="‚ö°Ô∏èZAPBOX WEB INSTALLER" />
    <meta property="og:description"
        content="Flash & config your ZapBox from the browser" />
    <meta property="og:url" content="https://ereignishorizont.xyz/ZapBox/" />
    <meta property="og:image" content="https://ereignishorizont.xyz/ZapBox/assets/zapbox-social.webp" />

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://ereignishorizont.xyz/ZapBox">
    <meta name="twitter:title" content="‚ö°Ô∏èZAPBOX WEB INSTALLER" />
    <meta name="twitter:description" content="Flash & config your ZapBox from the browser">
    <meta name="twitter:image" content="https://ereignishorizont.xyz/ZapBox/assets/zapbox-social.webp" />

    <link rel="icon" href="./assets/favicon.webp" sizes="32x32">
    <link rel="stylesheet" href="./assets/style.css">
    <script src="./assets/serial.js"></script>
    <script type="module" src="https://unpkg.com/esp-web-tools@9/dist/web/install-button.js?module"></script>
</head>

<body>
    <div class="wrapper">

        <noscript>
            <p>
                I'm sorry! For this to actully work you have to enable JavaScript in your browser.
            </p>
        </noscript>

        <h1 style="margin-bottom: 5px; display: inline-block;">‚ö°Ô∏èZAPBOX WEB INSTALLER</h1>
        <p style="display: inline-block; margin: 0 0 0 10px; vertical-align: baseline;"><i>(Use with LILYGO T-Display-S3)</i></p>
        <div style="margin-bottom: 30px;"></div>

        <h2 id="flash">1- Flash firmware</h2>

        <ul>
            <li>Connect your ZapBox to the front USB port</li>
            <li>Keep latest or select your version from the drop-down menu</li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üî• Flash</span> - select the connection and follow screen instructions</li>
        </ul>

        <!-- ##### Version selector and flash button ##### -->

        <div class="buttons" style="display: flex; gap: 10px; align-items: center;">
            <select id="firmware-version" style="padding: 10px; font-size: 16px; border-radius: 4px;">
                <option value="./firmware/v926705/manifest.json">v926705 (Latest - Add Threshold Mode with configurable payment trigger) üéâ</option>
                <option value="./firmware/v926666/manifest.json">v926666 (Add wss:// support for LNbits v1.3.1 and bS_extension v1.1.2)</option>
                <option value="./firmware/v926561/manifest.json">v926561 (Fix some bugs and edit documentation)</option>
                <option value="./firmware/v926531/manifest.json">v926531 (Initial Release - LNbits v0.12.12 / LNURLdevice v.0.6.9)</option>
            </select>
            
            <esp-web-install-button id="flash-button" manifest="./firmware/v926705/manifest.json">
                <button slot="activate">üî• Flash</button>
                <span slot="unsupported">Your browser does not support installing things on ESP devices. Use Google Chrome or Microsoft Edge.</span>
                <span slot="not-allowed">Ah snap, you are not allowed to use this on HTTP!</span>
            </esp-web-install-button>
        </div>

        <p><i>Note: The configuration data can be deleted using "Erase device." Otherwise, it will be retained even with the new firmware. You can use LOGS & CONSOLE for debugging. To do this, press the RESET DEVICE button.</i></p>
        
        <script>
            // Update manifest when version is changed
            document.getElementById('firmware-version').addEventListener('change', function(e) {
                const flashButton = document.getElementById('flash-button');
                flashButton.setAttribute('manifest', e.target.value);
                console.log('Manifest changed to:', e.target.value);
            });
        </script>

        <hr>

        <h2 id="prepare-connection">2- Prepare connection</h2>

        <p>Flash the ESP32 with "Erase device" and then wait 10 seconds until the "CONF / SERIAL CONFIG MODE" window appears.</p>

        <p>Alternatively, press the BOOT button (not HELP) for 5 seconds until the window appears.</p>

        <p>‚Üí The ZapBox is now ready to receive configuration data.</p>

        <p><i>Note: If data is already available and you start the connection with the Boot button, the connection will remain active for 3 minutes (180 seconds) before being automatically disconnected to release the QR code again. Data communication extends the channel open time by another 3 minutes.</i></p>

        <hr>

        <h2 id="load-config">3- Load config values</h2>

        <ul>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üîå Connect</span> - select the connection and connect</li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üìñ Read Config</span> if values are available</li>
            <li>Define your configuration üìù</li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üî• Write Config</span></li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üîÑ Restart</span> to restart while staying connected</li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üîå Disconnect</span> or refresh website to close connection</li>
        </ul>

        <div class="buttons">
            <button id="connect-button" onclick="onConnectButtonClick()">üîå Connect</button>
            <button id="read-config-button" onclick="onReadConfigButtonClick()" disabled>üìñ Read Config</button>
            <button id="write-config-button" onclick="onWriteConfigButtonClick()" disabled>üî• Write Config</button>
            <button id="soft-reset-button" onclick="onSoftResetButtonClick()" disabled>üîÑ Restart</button>
            <button id="restart-button" onclick="onRestartButtonClick()" disabled>üîå Disconnect</button>
        </div>

        <div class="input-wrapper">
            <div>
                <label for="ssid">WiFi SSID</label>
                <input type="text" name="ssid" id="ssid" placeholder="SSID" autocomplete="off">
            </div>
            <div>
                <label for="wifiPassword">WiFi password</label>
                <input type="text" name="wifiPassword" id="wifiPassword" placeholder="password" autocomplete="off">
            </div>
            <div>
                <label for="socket">Device settings string</label>
                <input type="text" name="socket" id="socket" placeholder="ws://demo.lnbits.com/ap..." autocomplete="off">
            </div>
            <div>
                <label for="lnurl">LNURL for QR-Code</label>
                <input type="text" name="lnurl" id="lnurl" placeholder="LNURL..." autocomplete="off">
            </div>
            <div>
                <label for="orientation">Screen orientation</label>
                <select name="orientation" id="orientation">
                    <option value="v">Vertical</option>
                    <option value="h" selected>Horizontal</option>
                </select>
            </div>
            <div>
                <label for="theme">Theme (Maybe in the future..)</label>
                <select name="theme" id="theme">
                    <option value="compact" selected>ZapBox compact</option>
                </select>
            </div>
        </div>

        <div class="debug-console" id="consoleDebug"></div>
        
        <!-- Threshold Feature Section - After Terminal -->
        <div style="margin-top: 50px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: -10px;">
                <h4 style="margin: 0; color: #666; font-weight: 500; white-space: nowrap;">Optional feature - Threshold</h4>
                <hr style="flex: 1; border: none; border-top: 1px solid #ddd; margin: 0;">
            </div>
            
            <div class="input-wrapper">
                <div>
                    <label for="thresholdKey">Wallet Invoice/Read Key</label>
                    <input type="text" name="thresholdKey" id="thresholdKey" placeholder="e.g. c9e68ab036.." autocomplete="off">
                    <p style="margin: -13px 0 0 0; font-size: 11px; color: #999; font-style: italic;">leave empty for normal mode</p>
                </div>
                <div>
                    <label for="thresholdAmount">Threshold value in satoshi</label>
                    <input type="number" name="thresholdAmount" id="thresholdAmount" placeholder="e.g. 2100" autocomplete="off">
                    <p style="margin: -13px 0 0 0; font-size: 11px; color: transparent; font-style: italic; user-select: none;">placeholder</p>
                </div>
                <div>
                    <label for="thresholdPin">GPIO pin to be controlled</label>
                    <input type="number" name="thresholdPin" id="thresholdPin" placeholder="e.g. 12" autocomplete="off">
                </div>
                <div>
                    <label for="thresholdTime">Control time for GPIO pin (ms)</label>
                    <input type="number" name="thresholdTime" id="thresholdTime" placeholder="e.g. 3000" autocomplete="off">
                </div>
                <div>
                    <label for="thresholdLnurl">LNURL or LIGHTNING ADDRESS for QR-Code</label>
                    <input type="text" name="thresholdLnurl" id="thresholdLnurl" placeholder="LNURL or lightning address" autocomplete="off">
                </div>
            </div>
            
            <p style="margin-top: 20px;"><i><strong>Note:</strong> As soon as something is entered in the "Wallet Invoice/Read Key" field, "THRESHOLD MODE" becomes active. "NORMAL MODE" then no longer works. The data specified in the bitcoinSwitch extension, such as amount, PIN, and time, is ignored. Only a payment to the wallet with the invoice key counts.</i></p>
            
            <p style="margin-top: 10px;"><i><strong>How can I use this?</strong> Either by receiving payment directly into the wallet or by using the "Pay Links" extension. There you can get a static LNURL and even a lightning address. Payments to these addresses then trigger the pin, provided the threshold value is reached or exceeded.</i></p>
        </div>

        <!-- Visual Separator -->
        <hr style="margin: 40px 0 30px 0; border: none; border-top: 1px solid #ccc;">

        <p style="text-align: center; font-size: 18px; margin-top: 20px;"><strong>Congratulations on configuring your own ZapBox! üéâ</strong></p>

        <p><i>Note: You can view the logs for debugging purposes when you are connected and press üîÑ Restart. Under point 1, you can also connect via a terminal window without having to put the ZapBox into SERIAL CONFIG MODE. To do this, select the üî• Flash button, then LOGS & CONSOLE, and then RESET DEVICE.</i></p>

        <hr>

        <h2 id="troubleshoot">Troubleshoot</h2>

        <h3 id="mostimportant">Most important:</h3>

        <p>If something does not work properly, especially with serial communication "üìñ Read Config", try again and again. If that does not help, refresh the website üîÑ with CTRL+F5 or CTRL+SHIFT+R and start over.</p>
        
        <h3 id="hardwareproblems">Hardware problems:</h3>

        <p>If non of the above works, reset board in boot mode and start over.</p>
            <ul>
                <li>Connect the board via the USB cable</li>
                <li>Press and hold the BOOT button</li>
                <li>While still pressing the BOOT button, press RESET</li>
                <li>Release the RESET button</li>
                <li>Release the BOOT button</li>
                <li><a href="#flash">Go to step 1</a></li>
            </ul>
        <img class="center-img" src="./assets/troubleshoot.jpg" />

        <footer>
            <p>Built on the shoulders of giants by <a href="https://njump.to/npub1yynthqj2zv663t0v8jtmtnwm34ak2fwe6zys043weqlnxgyuw7qqnk23ds" target="_blank" rel="noopener noreferrer">@axelhamburch</a> | <a href="https://github.com/AxelHamburch/ZapBox" target="_blank" rel="noopener noreferrer">Github repo</a></p>
        </footer>
    </div>

    <script>
        const consoleDebug = document.getElementById('consoleDebug');
        const ssid = document.getElementById('ssid');
        const wifiPassword = document.getElementById('wifiPassword');
        const socket = document.getElementById('socket');
        const lnurl = document.getElementById('lnurl');
        const orientation = document.getElementById('orientation');
        const thresholdKey = document.getElementById('thresholdKey');
        const thresholdAmount = document.getElementById('thresholdAmount');
        const thresholdPin = document.getElementById('thresholdPin');
        const thresholdTime = document.getElementById('thresholdTime');
        const thresholdLnurl = document.getElementById('thresholdLnurl');

        let config = [
            {
                "name": "ssid",
                "value": ""
            },
            {
                "name": "wifipassword",
                "value": ""
            },
            {
                "name": "socket",
                "value": ""
            },
            {
                "name": "lnurl",
                "value": ""
            },
            {
                "name": "orientation",
                "value": "h"
            },
            {
                "name": "thresholdKey",
                "value": ""
            },
            {
                "name": "thresholdAmount",
                "value": ""
            },
            {
                "name": "thresholdPin",
                "value": ""
            },
            {
                "name": "thresholdTime",
                "value": ""
            },
            {
                "name": "thresholdLnurl",
                "value": ""
            }
        ]

        // Setup Web Serial using serial.js
        const serial = new Serial();
        serial.on(SerialEvents.CONNECTION_OPENED, onSerialConnectionOpened);
        serial.on(SerialEvents.CONNECTION_CLOSED, onSerialConnectionClosed);
        serial.on(SerialEvents.DATA_RECEIVED, onSerialDataReceived);
        serial.on(SerialEvents.ERROR_OCCURRED, onSerialErrorOccurred);

        function onSerialErrorOccurred(eventSender, error) {
            console.log("onSerialErrorOccurred", error);
        }

        let configModeCheckTimeout = null;
        let configModeVerified = false;
        let helloSendTimeout = null;
        let serialBuffer = ""; // Buffer for incoming serial data

        function onSerialConnectionOpened(eventSender) {
            console.log("onSerialConnectionOpened", eventSender);
            
            // Reset config mode flag
            configModeVerified = false;
            
            // Disable all buttons initially
            document.getElementById("connect-button").disabled = true;
            document.getElementById("read-config-button").disabled = true;
            document.getElementById("write-config-button").disabled = true;
            document.getElementById("soft-reset-button").disabled = true;
            document.getElementById("restart-button").disabled = true;
            
            const checkMsg = document.createElement('span');
            checkMsg.style.color = '#888';
            checkMsg.textContent = 'Checking for config mode...\n';
            consoleDebug.appendChild(checkMsg);
            consoleDebug.scrollTop = consoleDebug.scrollHeight;
            
            // Wait 500ms first to see if normal program output comes
            // If nothing comes, then send /hello
            helloSendTimeout = setTimeout(() => {
                if (configModeVerified === false) {
                    // No normal program output detected, send /hello
                    serial.writeLine("/hello");
                }
            }, 500);
            
            // Set timeout for config mode verification (3 seconds total)
            configModeCheckTimeout = setTimeout(() => {
                if (!configModeVerified) {
                    console.log("Config mode verification timeout - no ASCII art response");
                    const timeoutMsg = document.createElement('span');
                    timeoutMsg.style.color = '#ff4444';
                    timeoutMsg.textContent = '‚ö†Ô∏è Timeout - Device not in config mode\n';
                    consoleDebug.appendChild(timeoutMsg);
                    consoleDebug.scrollTop = consoleDebug.scrollHeight;
                    alert("‚ö†Ô∏è No serial config mode active\n\nPlease enter config mode by:\n- Holding BOOT button for 2-3 seconds, or\n- Flashing fresh firmware with empty config");
                    serial.close();
                }
            }, 3000);
        }

        function onSerialConnectionClosed(eventSender) {
            console.log("onSerialConnectionClosed", eventSender);
            
            // Clear timeouts if still running
            if (helloSendTimeout) {
                clearTimeout(helloSendTimeout);
                helloSendTimeout = null;
            }
            if (configModeCheckTimeout) {
                clearTimeout(configModeCheckTimeout);
                configModeCheckTimeout = null;
            }
            
            // Reset verification flag and buffer
            configModeVerified = false;
            serialBuffer = "";
            
            document.getElementById("connect-button").disabled = false;
            document.getElementById("read-config-button").disabled = true;
            document.getElementById("write-config-button").disabled = true;
            document.getElementById("soft-reset-button").disabled = true;
            document.getElementById("restart-button").disabled = true;
        }

        function onSerialDataReceived(eventSender, newData) {
            console.log("onSerialDataReceived", eventSender);
            console.log("Received data:", newData);
            
            // Append text without HTML parsing to preserve ASCII art formatting
            const textNode = document.createTextNode(newData + '\n');
            consoleDebug.appendChild(textNode);
            consoleDebug.scrollTop = consoleDebug.scrollHeight;

            // Check if ESP32 is in Serial Config Mode (only once!)
            if (!configModeVerified) {
                // FIRST: Check if we receive normal program output - this means NOT in config mode
                const hasNormalProgramOutput = newData.includes("[LOOP]") || 
                                              newData.includes("[WS]") ||
                                              newData.includes("Still waiting") ||
                                              newData.includes("[CHECK]");
                
                if (hasNormalProgramOutput) {
                    console.log("Normal program detected - NOT in config mode");
                    configModeVerified = null; // Mark as failed (not false, not true)
                    
                    // Cancel the /hello send timeout
                    if (helloSendTimeout) {
                        clearTimeout(helloSendTimeout);
                        helloSendTimeout = null;
                    }
                    
                    // Clear the main timeout
                    if (configModeCheckTimeout) {
                        clearTimeout(configModeCheckTimeout);
                        configModeCheckTimeout = null;
                    }
                    
                    const errorMsg = document.createElement('span');
                    errorMsg.style.color = '#ff4444';
                    errorMsg.textContent = '‚ö†Ô∏è Normal program running - not in config mode\n';
                    consoleDebug.appendChild(errorMsg);
                    consoleDebug.scrollTop = consoleDebug.scrollHeight;
                    alert("‚ö†Ô∏è No serial config mode active\n\nPlease enter config mode by:\n- Holding BOOT button for 2-3 seconds, or\n- Flashing fresh firmware with empty config");
                    serial.close();
                    return; // Exit early
                }
                
                // SECOND: If we receive the ASCII art response to /hello, config mode is active
                const hasAsciiArt = newData.includes("____") || 
                                   newData.includes("/_  /") || 
                                   newData.includes("/___/");
                
                if (hasAsciiArt) {
                    console.log("Config mode verified - ESP32 responded with ASCII art!");
                    configModeVerified = true; // Set BEFORE doing anything else to prevent re-triggering!
                    
                    // Clear the timeouts
                    if (helloSendTimeout) {
                        clearTimeout(helloSendTimeout);
                        helloSendTimeout = null;
                    }
                    if (configModeCheckTimeout) {
                        clearTimeout(configModeCheckTimeout);
                        configModeCheckTimeout = null;
                    }
                    
                    // Wait 500ms for ASCII art to finish rendering, then show success message
                    setTimeout(() => {
                        const successMsg = document.createElement('span');
                        successMsg.style.color = '#00ff00';
                        successMsg.textContent = '\n‚úì Config mode active\n';
                        consoleDebug.appendChild(successMsg);
                        consoleDebug.scrollTop = consoleDebug.scrollHeight;
                    }, 500);
                    
                    // Enable buttons after verification
                    document.getElementById("connect-button").disabled = true;
                    document.getElementById("read-config-button").disabled = false;
                    document.getElementById("write-config-button").disabled = false;
                    document.getElementById("soft-reset-button").disabled = false;
                    document.getElementById("restart-button").disabled = false;
                }
            }

            // Accumulate serial data in buffer
            serialBuffer += newData;

            // Try to parse config data when we see /file-read
            if (serialBuffer.includes("/file-read ")) {
                tryParseConfig();
            }


            // Check for "no config file" message
            if (newData.includes("- Failed to open file for reading")) {
                alert("There is no config in the device, please fill options and write.");
            }
        }

        function tryParseConfig() {
            // Look for /file-read followed by JSON array
            let fileReadIndex = serialBuffer.lastIndexOf("/file-read ");
            if (fileReadIndex === -1) return;

            // Extract everything after /file-read
            let afterFileRead = serialBuffer.substring(fileReadIndex);
            
            // Find complete JSON array with matching brackets
            let jsonStart = afterFileRead.indexOf("[");
            if (jsonStart === -1) return;
            
            let bracketCount = 0;
            let inString = false;
            let escape = false;
            let jsonEnd = -1;
            
            for (let i = jsonStart; i < afterFileRead.length; i++) {
                let char = afterFileRead[i];
                
                if (escape) {
                    escape = false;
                    continue;
                }
                
                if (char === '\\') {
                    escape = true;
                    continue;
                }
                
                if (char === '"') {
                    inString = !inString;
                    continue;
                }
                
                if (!inString) {
                    if (char === '[') bracketCount++;
                    if (char === ']') {
                        bracketCount--;
                        if (bracketCount === 0) {
                            jsonEnd = i;
                            break;
                        }
                    }
                }
            }
            
            // Found complete JSON with matching brackets
            if (jsonEnd === -1) return;
            
            let jsonString = afterFileRead.substring(jsonStart, jsonEnd + 1);

            try {
                let configData = JSON.parse(jsonString);

                // Verify it's config data with expected structure
                if (!Array.isArray(configData) || configData.length < 5 || configData[0]?.name !== "ssid") {
                    return;
                }

                // Update config object
                config[0].value = configData[0].value; // ssid
                config[1].value = configData[1].value; // wifiPassword
                config[2].value = configData[2].value; // socket
                config[3].value = configData[3].value; // lnurl
                config[4].value = configData[4].value; // orientation
                config[5].value = configData[5]?.value || ""; // thresholdKey
                config[6].value = configData[6]?.value || ""; // thresholdAmount
                config[7].value = configData[7]?.value || ""; // thresholdPin
                config[8].value = configData[8]?.value || ""; // thresholdTime
                config[9].value = configData[9]?.value || ""; // thresholdLnurl

                // Fill form fields
                ssid.value = config[0].value;
                wifiPassword.value = config[1].value;
                socket.value = config[2].value;
                lnurl.value = config[3].value;
                orientation.value = config[4].value;
                thresholdKey.value = config[5].value;
                thresholdAmount.value = config[6].value;
                thresholdPin.value = config[7].value;
                thresholdTime.value = config[8].value;
                thresholdLnurl.value = config[9].value;

                console.log("Config loaded:", config);
                
                // Show success message
                const successMsg = document.createElement('span');
                successMsg.style.color = '#00ff00';
                successMsg.textContent = '\n‚úì Data loaded\n';
                consoleDebug.appendChild(successMsg);
                consoleDebug.scrollTop = consoleDebug.scrollHeight;
                
                // Clear buffer after successful parse
                serialBuffer = "";
            } catch (error) {
                // Silent - wait for more data
                console.log("JSON parse attempt failed:", error);
            }
        }

        async function onConnectButtonClick() {
            console.log("Connect button clicked!");

            if (navigator.serial) {
                if (!serial.isOpen()) {
                    await serial.connectAndOpen(portFilters = null, serialOptions = { baudRate: 115200 })
                } else {
                    console.log("The serial connection appears already open");
                }
            } else {
                alert('‚ö†Ô∏è The Web Serial API does not appear supported on this web browser.');
            }
        }

        async function onReadConfigButtonClick() {
            console.log("Read config button clicked!");
            serial.writeLine("/file-read config.json");
        }

        async function onWriteConfigButtonClick() {
            console.log("Write config button clicked!");
            serial.writeLine("/file-remove config.json");
            serial.writeLine("/file-append config.json " + JSON.stringify(config));
            
            // Wait a moment for command to be processed
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Show success message
            const successMsg = document.createElement('span');
            successMsg.style.color = '#00ff00';
            successMsg.textContent = '‚úì Data written\n';
            consoleDebug.appendChild(successMsg);
            consoleDebug.scrollTop = consoleDebug.scrollHeight;
        }

        async function onSoftResetButtonClick() {
            console.log("Restart button clicked!");
            const resetMsg = document.createElement('span');
            resetMsg.style.color = '#ffaa00';
            resetMsg.textContent = 'Sending restart command...\n';
            consoleDebug.appendChild(resetMsg);
            consoleDebug.scrollTop = consoleDebug.scrollHeight;
            
            // Send soft reset command - keeps connection open
            serial.writeLine("/config-soft-reset");
            
            // Wait for device to restart
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const doneMsg = document.createElement('span');
            doneMsg.style.color = '#00ff00';
            doneMsg.textContent = '‚úì Device restarted (connection remains open)\n';
            consoleDebug.appendChild(doneMsg);
            consoleDebug.scrollTop = consoleDebug.scrollHeight;
        }

        async function onRestartButtonClick() {
            console.log("Disconnect button clicked!");
            if (confirm("Are you sure you want to disconnect?")) {
                const restartMsg = document.createElement('span');
                restartMsg.style.color = '#ffaa00';
                restartMsg.textContent = 'Disconnecting...\n';
                consoleDebug.appendChild(restartMsg);
                consoleDebug.scrollTop = consoleDebug.scrollHeight;
                
                // Send restart command
                serial.writeLine("/config-restart");
                
                // Wait a moment for command to be sent
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Close serial connection before device restarts
                if (serial.isOpen()) {
                    await serial.close();
                    consoleDebug.innerHTML += '<b>Connection closed.</b><br>';
                    consoleDebug.scrollTop = consoleDebug.scrollHeight;
                }
            }
        }

        ssid.addEventListener("input", (event) => {
            config[0].value = event.target.value;
        });

        wifiPassword.addEventListener("input", (event) => {
            config[1].value = event.target.value;
        });

        socket.addEventListener("input", (event) => {
            config[2].value = event.target.value;
        });

        lnurl.addEventListener("input", (event) => {
            config[3].value = event.target.value;
        });

        orientation.addEventListener("change", (event) => {
            config[4].value = event.target.value;
        });

        thresholdKey.addEventListener("input", (event) => {
            config[5].value = event.target.value;
        });

        thresholdAmount.addEventListener("input", (event) => {
            config[6].value = event.target.value;
        });

        thresholdPin.addEventListener("input", (event) => {
            config[7].value = event.target.value;
        });

        thresholdTime.addEventListener("input", (event) => {
            config[8].value = event.target.value;
        });

        thresholdLnurl.addEventListener("input", (event) => {
            config[9].value = event.target.value;
        });

    </script>

</body>
</html>