<!DOCTYPE html>
<html lang="en">

<head>
    <title>‚ö°Ô∏èZAPBOX WEB INSTALLER</title>

    <!-- Primary Meta Tags -->
    <meta name="description" content="Flash & config your ZapBox from the browser">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />

    <!-- Open Graph -->
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="‚ö°Ô∏èZAPBOX WEB INSTALLER" />
    <meta property="og:description"
        content="Flash & config your ZapBox from the browser" />
    <meta property="og:url" content="https://ereignishorizont.xyz/ZapBox/" />
    <meta property="og:image" content="https://ereignishorizont.xyz/ZapBox/assets/zapbox-social.webp" />

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://ereignishorizont.xyz/ZapBox">
    <meta name="twitter:title" content="‚ö°Ô∏èZAPBOX WEB INSTALLER" />
    <meta name="twitter:description" content="Flash & config your ZapBox from the browser">
    <meta name="twitter:image" content="https://ereignishorizont.xyz/ZapBox/assets/zapbox-social.webp" />

    <link rel="icon" href="./assets/favicon.webp" sizes="32x32">
    <link rel="stylesheet" href="./assets/style.css">
    <script src="./assets/serial.js"></script>
    <script type="module" src="https://unpkg.com/esp-web-tools@9/dist/web/install-button.js?module"></script>
</head>

<body>
    <div class="wrapper">

        <noscript>
            <p>
                I'm sorry! For this to actully work you have to enable JavaScript in your browser.
            </p>
        </noscript>

        <h1 style="margin-bottom: 5px;">ZAPBOX WEB INSTALLER</h1>
        <p style="margin-top: 0px; margin-bottom: 30px;"><i>(Use with LILYGO T-Display-S3)</i></p>

        <h2 id="flash">1- Flash firmware</h2>

        <ul>
            <li>Connect your ZapBox to the front USB port</li>
            <li>Keep latest or select your version from the drop-down menu</li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üî• Flash</span> - select the connection and follow screen instructions</li>
        </ul>

        <!-- ##### Version selector and flash button ##### -->

        <div class="buttons" style="display: flex; gap: 10px; align-items: center;">
            <select id="firmware-version" style="padding: 10px; font-size: 16px; border-radius: 4px;">
                <option value="./firmware/v926531/manifest.json">Version 926531 (Initial Release - LNbits v0.12.12 / LNURLdevice v.0.6.9)</option>
            </select>
            
            <esp-web-install-button id="flash-button" manifest="./firmware/v926531/manifest.json">
                <button slot="activate">üî• Flash</button>
                <span slot="unsupported">Your browser does not support installing things on ESP devices. Use Google Chrome or Microsoft Edge.</span>
                <span slot="not-allowed">Ah snap, you are not allowed to use this on HTTP!</span>
            </esp-web-install-button>
        </div>

        <p><i>Note: The configuration data can be deleted using "Erase device." Otherwise, it will be retained even with the new firmware. You can use LOGS & CONSOLE for debugging. To do this, press the RESET DEVICE button.</i></p>
        
        <script>
            // Update manifest when version is changed
            document.getElementById('firmware-version').addEventListener('change', function(e) {
                const flashButton = document.getElementById('flash-button');
                flashButton.setAttribute('manifest', e.target.value);
                console.log('Manifest changed to:', e.target.value);
            });
        </script>

        <hr>

        <h2 id="prepare-connection">2- Prepare connection</h2>

        <p>Flash the ESP32 with "Erase device" and then wait 10 seconds until the "CONF / SERIAL CONFIG MODE" window appears.</p>

        <p>Alternatively, press the BOOT button (not HELP) for 5 seconds until the window appears.</p>

        <p>‚Üí The ZapBox is now ready to receive configuration data.</p>

        <hr>

        <h2 id="load-config">3- Load config values</h2>

        <ul>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üîå Connect</span></li>
            <li>Select the connection and connect</li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üìñ Read Config</span> if values are available</li>
            <li>Define your configuration</li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üî• Write Config</span></li>
            <li>Press <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 3px;">üîÑ Restart Device</span> and Enjoy</li>
        </ul>

        <div class="buttons">
            <button id="connect-button" onclick="onConnectButtonClick()">üîå Connect</button>
            <button id="read-config-button" onclick="onReadConfigButtonClick()" disabled>üìñ Read Config</button>
            <button id="write-config-button" onclick="onWriteConfigButtonClick()" disabled>üî• Write Config</button>
            <button id="restart-button" onclick="onRestartButtonClick()" disabled>üîÑ Restart Device</button>
        </div>

        <div class="input-wrapper">
            <div>
                <label for="ssid">WiFi SSID</label>
                <input type="text" name="ssid" id="ssid" placeholder="SSID">
            </div>
            <div>
                <label for="wifiPassword">WiFi password</label>
                <input type="text" name="wifiPassword" id="wifiPassword" placeholder="password">
            </div>
            <div>
                <label for="socket">Device settings string</label>
                <input type="text" name="socket" id="socket" placeholder="ws://demo.lnbits.com/ap...">
            </div>
            <div>
                <label for="lnurl">LNURL from device instance</label>
                <input type="text" name="lnurl" id="lnurl" placeholder="LNURL...">
            </div>
            <div>
                <label for="orientation">Screen orientation</label>
                <select name="orientation" id="orientation">
                    <option value="v">Vertical</option>
                    <option value="h" selected>Horizontal</option>
                </select>
            </div>
            <div>
                <label for="theme">Theme (Maybe in the future..)</label>
                <select name="theme" id="theme">
                    <option value="compact" selected>ZapBox compact</option>
                </select>
            </div>
        </div>

        <div class="debug-console" id="consoleDebug"></div>

        <p style="text-align: center; font-size: 18px; margin-top: 20px;"><strong>Congratulations on configuring your own ZapBox! üéâ</strong></p>

        <p><i>Note: If you want to debug now, you can go to point 1 and select LOGS & CONSOLE. Select RESET DEVICE once and you will see the ZapBox logs.</i></p>

        <hr>

        <h2 id="troubleshoot">Troubleshoot</h2>
        <p>If non of the above works, reset board in boot mode and start over.</p>
            <ul>
                <li>Connect the board via the USB cable</li>
                <li>Press and hold the BOOT button</li>
                <li>While still pressing the BOOT button, press RESET</li>
                <li>Release the RESET button</li>
                <li>Release the BOOT button</li>
                <li><a href="#flash">Go to step 1</a></li>
            </ul>
        <img class="center-img" src="./assets/troubleshoot.jpg" />

        <footer>
            <p>Built on the shoulders of giants by <a href="https://njump.to/npub1yynthqj2zv663t0v8jtmtnwm34ak2fwe6zys043weqlnxgyuw7qqnk23ds" target="_blank" rel="noopener noreferrer">@axelhamburch</a> | <a href="https://github.com/AxelHamburch/ZapBox" target="_blank" rel="noopener noreferrer">Github repo</a></p>
        </footer>
    </div>

    <script>
        const consoleDebug = document.getElementById('consoleDebug');
        const ssid = document.getElementById('ssid');
        const wifiPassword = document.getElementById('wifiPassword');
        const socket = document.getElementById('socket');
        const lnurl = document.getElementById('lnurl');
        const orientation = document.getElementById('orientation');

        let config = [
            {
                "name": "ssid",
                "value": ""
            },
            {
                "name": "wifipassword",
                "value": ""
            },
            {
                "name": "socket",
                "value": ""
            },
            {
                "name": "lnurl",
                "value": ""
            },
            {
                "name": "orientation",
                "value": ""
            }
        ]

        // Setup Web Serial using serial.js
        const serial = new Serial();
        serial.on(SerialEvents.CONNECTION_OPENED, onSerialConnectionOpened);
        serial.on(SerialEvents.CONNECTION_CLOSED, onSerialConnectionClosed);
        serial.on(SerialEvents.DATA_RECEIVED, onSerialDataReceived);
        serial.on(SerialEvents.ERROR_OCCURRED, onSerialErrorOccurred);

        function onSerialErrorOccurred(eventSender, error) {
            console.log("onSerialErrorOccurred", error);
        }

        let configModeCheckTimeout = null;
        let configModeVerified = false;
        let helloSendTimeout = null;

        function onSerialConnectionOpened(eventSender) {
            console.log("onSerialConnectionOpened", eventSender);
            
            // Reset config mode flag
            configModeVerified = false;
            
            // Disable all buttons initially
            document.getElementById("connect-button").disabled = true;
            document.getElementById("read-config-button").disabled = true;
            document.getElementById("write-config-button").disabled = true;
            document.getElementById("restart-button").disabled = true;
            
            const checkMsg = document.createElement('span');
            checkMsg.style.color = '#888';
            checkMsg.textContent = 'Checking for config mode...\n';
            consoleDebug.appendChild(checkMsg);
            consoleDebug.scrollTop = consoleDebug.scrollHeight;
            
            // Wait 500ms first to see if normal program output comes
            // If nothing comes, then send /hello
            helloSendTimeout = setTimeout(() => {
                if (configModeVerified === false) {
                    // No normal program output detected, send /hello
                    serial.writeLine("/hello");
                }
            }, 500);
            
            // Set timeout for config mode verification (3 seconds total)
            configModeCheckTimeout = setTimeout(() => {
                if (!configModeVerified) {
                    console.log("Config mode verification timeout - no ASCII art response");
                    const timeoutMsg = document.createElement('span');
                    timeoutMsg.style.color = '#ff4444';
                    timeoutMsg.textContent = '‚ö†Ô∏è Timeout - Device not in config mode\n';
                    consoleDebug.appendChild(timeoutMsg);
                    consoleDebug.scrollTop = consoleDebug.scrollHeight;
                    alert("‚ö†Ô∏è No serial config mode active\n\nPlease enter config mode by:\n- Holding BOOT button for 2-3 seconds, or\n- Flashing fresh firmware with empty config");
                    serial.close();
                }
            }, 3000);
        }

        function onSerialConnectionClosed(eventSender) {
            console.log("onSerialConnectionClosed", eventSender);
            
            // Clear timeouts if still running
            if (helloSendTimeout) {
                clearTimeout(helloSendTimeout);
                helloSendTimeout = null;
            }
            if (configModeCheckTimeout) {
                clearTimeout(configModeCheckTimeout);
                configModeCheckTimeout = null;
            }
            
            // Reset verification flag
            configModeVerified = false;
            
            document.getElementById("connect-button").disabled = false;
            document.getElementById("read-config-button").disabled = true;
            document.getElementById("write-config-button").disabled = true;
            document.getElementById("restart-button").disabled = true;
        }

        function onSerialDataReceived(eventSender, newData) {
            console.log("onSerialDataReceived", eventSender);
            console.log("Received data:", newData);
            
            // Append text without HTML parsing to preserve ASCII art formatting
            const textNode = document.createTextNode(newData + '\n');
            consoleDebug.appendChild(textNode);
            consoleDebug.scrollTop = consoleDebug.scrollHeight;

            // Check if ESP32 is in Serial Config Mode (only once!)
            if (!configModeVerified) {
                // FIRST: Check if we receive normal program output - this means NOT in config mode
                const hasNormalProgramOutput = newData.includes("[LOOP]") || 
                                              newData.includes("[WS]") ||
                                              newData.includes("Still waiting") ||
                                              newData.includes("[CHECK]");
                
                if (hasNormalProgramOutput) {
                    console.log("Normal program detected - NOT in config mode");
                    configModeVerified = null; // Mark as failed (not false, not true)
                    
                    // Cancel the /hello send timeout
                    if (helloSendTimeout) {
                        clearTimeout(helloSendTimeout);
                        helloSendTimeout = null;
                    }
                    
                    // Clear the main timeout
                    if (configModeCheckTimeout) {
                        clearTimeout(configModeCheckTimeout);
                        configModeCheckTimeout = null;
                    }
                    
                    const errorMsg = document.createElement('span');
                    errorMsg.style.color = '#ff4444';
                    errorMsg.textContent = '‚ö†Ô∏è Normal program running - not in config mode\n';
                    consoleDebug.appendChild(errorMsg);
                    consoleDebug.scrollTop = consoleDebug.scrollHeight;
                    alert("‚ö†Ô∏è No serial config mode active\n\nPlease enter config mode by:\n- Holding BOOT button for 2-3 seconds, or\n- Flashing fresh firmware with empty config");
                    serial.close();
                    return; // Exit early
                }
                
                // SECOND: If we receive the ASCII art response to /hello, config mode is active
                const hasAsciiArt = newData.includes("____") || 
                                   newData.includes("/_  /") || 
                                   newData.includes("/___/");
                
                if (hasAsciiArt) {
                    console.log("Config mode verified - ESP32 responded with ASCII art!");
                    configModeVerified = true; // Set BEFORE doing anything else to prevent re-triggering!
                    
                    // Clear the timeouts
                    if (helloSendTimeout) {
                        clearTimeout(helloSendTimeout);
                        helloSendTimeout = null;
                    }
                    if (configModeCheckTimeout) {
                        clearTimeout(configModeCheckTimeout);
                        configModeCheckTimeout = null;
                    }
                    
                    // Wait 500ms for ASCII art to finish rendering, then show success message
                    setTimeout(() => {
                        const successMsg = document.createElement('span');
                        successMsg.style.color = '#00ff00';
                        successMsg.textContent = '\n‚úì Config mode active\n';
                        consoleDebug.appendChild(successMsg);
                        consoleDebug.scrollTop = consoleDebug.scrollHeight;
                    }, 500);
                    
                    // Enable buttons after verification
                    document.getElementById("connect-button").disabled = true;
                    document.getElementById("read-config-button").disabled = false;
                    document.getElementById("write-config-button").disabled = false;
                    document.getElementById("restart-button").disabled = false;
                }
            }

            // search for json string in serial resp
            let jsonString = newData.substring(
                newData.indexOf("["),
                newData.lastIndexOf("]") + 1
            );

            if (jsonString.length > 1) {
                try {
                    let configData = JSON.parse(jsonString);

                    // Update config object
                    config[0].value = configData[0].value; // ssid
                    config[1].value = configData[1].value; // wifiPassword
                    config[2].value = configData[2].value; // socket
                    config[3].value = configData[3].value; // lnurl
                    config[4].value = configData[4].value; // orientation

                    // Fill fields
                    ssid.value = config[0].value;
                    wifiPassword.value = config[1].value;
                    socket.value = config[2].value;
                    lnurl.value = config[3].value;
                    orientation.value = config[4].value;

                    console.log(config);
                } catch (error) {
                    console.log("Error parsing JSON config:", error);
                }
            }


            // search for "no config file" in serial resp
            let failedString = newData.search("- Failed to open file for reading");

            if (failedString !== -1) {
                alert("There is no config in the device, please fill options and write.")
            }
        }

        async function onConnectButtonClick() {
            console.log("Connect button clicked!");

            if (navigator.serial) {
                if (!serial.isOpen()) {
                    await serial.connectAndOpen(portFilters = null, serialOptions = { baudRate: 115200 })
                } else {
                    console.log("The serial connection appears already open");
                }
            } else {
                alert('‚ö†Ô∏è The Web Serial API does not appear supported on this web browser.');
            }
        }

        async function onReadConfigButtonClick() {
            console.log("Read config button clicked!");
            serial.writeLine("/file-read config.json");
        }

        async function onWriteConfigButtonClick() {
            console.log("Write config button clicked!");
            serial.writeLine("/file-remove config.json");
            serial.writeLine("/file-append config.json " + JSON.stringify(config));
        }

        async function onRestartButtonClick() {
            console.log("Restart button clicked!");
            if (confirm("Are you sure you want to restart the device?")) {
                const restartMsg = document.createElement('span');
                restartMsg.style.color = '#ffaa00';
                restartMsg.textContent = 'Sending restart command...\n';
                consoleDebug.appendChild(restartMsg);
                consoleDebug.scrollTop = consoleDebug.scrollHeight;
                
                // Send restart command
                serial.writeLine("/config-restart");
                
                // Wait a moment for command to be sent
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Close serial connection before device restarts
                if (serial.isOpen()) {
                    await serial.close();
                    consoleDebug.innerHTML += '<b>Device restarting. Connection closed.</b><br>';
                    consoleDebug.scrollTop = consoleDebug.scrollHeight;
                }
            }
        }

        ssid.addEventListener("input", (event) => {
            config[0].value = event.target.value;
        });

        wifiPassword.addEventListener("input", (event) => {
            config[1].value = event.target.value;
        });

        socket.addEventListener("input", (event) => {
            config[2].value = event.target.value;
        });

        lnurl.addEventListener("input", (event) => {
            config[3].value = event.target.value;
        });

        orientation.addEventListener("change", (event) => {
            config[4].value = event.target.value;
        });

    </script>

</body>
</html>